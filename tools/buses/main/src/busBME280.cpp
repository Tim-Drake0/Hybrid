
//This was autogenerated by generateBuses.py

#include "busBME280.h"
#include <string.h>
#include <Arduino.h>
#include <HardwareSerial.h>
#include "SensorDataFrame.h"

busBME280Config busBME280 = {
    6911,
    24,
    20,
    "little",
    "BME280",
    0,
    0,
    { 9999, "C", "float", 8, 4, 32, 0.0, 1.0, 0},
    { 9999, "Pa", "float", 12, 4, 32, 0.0, 1.0, 0},
    { 9999, "%", "float", 16, 4, 32, 0.0, 1.0, 0},
    { 9999, "m", "float", 20, 4, 32, 0.0, 1.0, 0}
};

const busBME280FieldConfig* busBME280Config::getField(const char* fieldName) const {
   if (strcmp(fieldName, "temperatureC") == 0) return &temperatureC;
   if (strcmp(fieldName, "pressurePasc") == 0) return &pressurePasc;
   if (strcmp(fieldName, "humidityRH") == 0) return &humidityRH;
   if (strcmp(fieldName, "altitudeM") == 0) return &altitudeM;

    return nullptr;
    
}

std::array<uint8_t, 24> busBME280Config::serialize(SensorDataFrame &frame) const {
    std::array<uint8_t, 24> buffer{};
    buffer.fill(0);
    
    union {float f;uint32_t u;} temperatureC_u;
    union {float f;uint32_t u;} pressurePasc_u;
    union {float f;uint32_t u;} humidityRH_u;
    union {float f;uint32_t u;} altitudeM_u;
    
    temperatureC_u.f = frame.temperatureC;
    pressurePasc_u.f = frame.pressurePasc;
    humidityRH_u.f = frame.humidityRH;
    altitudeM_u.f = frame.altitudeM;
    
    int i = 0;
    
    // ID
    buffer[i] = (6911 >> 8) & 0xFF; i++;
    buffer[i] = 6911 & 0xFF;        i++;   
    
    // Timestamp
    buffer[i] = (frame.currentMillis >> 24) & 0xFF; i++;
    buffer[i] = (frame.currentMillis >> 16) & 0xFF; i++;
    buffer[i] = (frame.currentMillis >> 8)  & 0xFF; i++;
    buffer[i] = frame.currentMillis & 0xFF;         i++;
    
    // Packets Sent
    buffer[i] = (busBME280.packetsSent >> 8) & 0xFF; i++;
    buffer[i] = busBME280.packetsSent & 0xFF;        i++;  
    
    //Data
    buffer[i] = (temperatureC_u.u >> 24) & 0xFF; i++;
    buffer[i] = (temperatureC_u.u >> 16) & 0xFF; i++;
    buffer[i] = (temperatureC_u.u >> 8)  & 0xFF; i++;
    buffer[i] = temperatureC_u.u & 0xFF;         i++;

    buffer[i] = (pressurePasc_u.u >> 24) & 0xFF; i++;
    buffer[i] = (pressurePasc_u.u >> 16) & 0xFF; i++;
    buffer[i] = (pressurePasc_u.u >> 8)  & 0xFF; i++;
    buffer[i] = pressurePasc_u.u & 0xFF;         i++;

    buffer[i] = (humidityRH_u.u >> 24) & 0xFF; i++;
    buffer[i] = (humidityRH_u.u >> 16) & 0xFF; i++;
    buffer[i] = (humidityRH_u.u >> 8)  & 0xFF; i++;
    buffer[i] = humidityRH_u.u & 0xFF;         i++;

    buffer[i] = (altitudeM_u.u >> 24) & 0xFF; i++;
    buffer[i] = (altitudeM_u.u >> 16) & 0xFF; i++;
    buffer[i] = (altitudeM_u.u >> 8)  & 0xFF; i++;
    buffer[i] = altitudeM_u.u & 0xFF;         i++;

    
    
    return buffer;
}

void busBME280Config::sendPacket(SensorDataFrame &frame, HardwareSerial &serial) const {
    auto busBME280_serialized = busBME280.serialize(frame);

    serial.write(busBME280_serialized.data(), busBME280_serialized.size());
    
    busBME280.packetsSent++;
    busBME280.lastSendTime = frame.currentMillis;
}

