#include "src/busPwr.h"
#include "src/busBME280.h"
#include "src/streamSerialTelem.h"
#include "src/SensorDataFrame.h"
#include <Arduino.h>
#include <HardwareSerial.h>
#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BME280.h>
#include <Adafruit_LSM9DS1.h>
#include <Adafruit_ADXL375.h>

#include <SPI.h> 

/*======================================================================
Author: Tim Drake


// TO DO: 
- add SensorDataFrame.cpp to be autogenerated based on yaml initial values
- make settings config file for sensor attributes (ex. for setupLSM9DS1())
- add SD card features
- figure out SPI!!!!!!!!!!!
    - manually read the sensor?
    - no library
    - stuttery gui
*/

#define LSM9DS1_REGISTER_OUT_X_L_XL (0x28)
#define LSM9DS1_REGISTER_OUT_X_L_G  (0x18)

const PinName CS_AG_pin = PA_2;
const PinName CS_MAG_pin = PA_3;


// Sensitivity scales (assuming default settings)
//#define ACCEL_SENS 0.000061 // g/LSB for ±2g
//#define GYRO_SENS  0.00875  // dps/LSB for ±245 dps
//#define MAG_SENS   0.00014  // Gauss/LSB for ±4 gauss

typedef struct{
  byte addr;
  float gainX;
  float gainY;
  float gainZ;
  int16_t rawX;
  int16_t rawY;
  int16_t rawZ;
  int16_t x;
  int16_t y;
  int16_t z;
  uint32_t timeLastSamp = 0UL;
  uint32_t timeBtwnSamp = 10000UL;
  int datarate = 0;
  int range = 0;
  boolean newSamp = false;
} sensorData;
sensorData accel;
sensorData gyro;
sensorData mag;

//TwoWire Wire2(PB11, PB10); // SDA, SCL for I2C2
HardwareSerial MySerial(USART1);

//Adafruit_BME280 bme;
////Adafruit_LSM9DS1 lsm = Adafruit_LSM9DS1(LSM9DS1_XGCS, LSM9DS1_MCS);
//Adafruit_ADXL375 adx = Adafruit_ADXL375(12345, &Wire2);

unsigned long lastSendTime = 0;
unsigned long lastReadPwr = 0;
unsigned long lastReadBME = 0;
unsigned long lastReadLSM = 0;
unsigned long lastReadADXL = 0;

void sendSerialBuses(){
    // send data over various serial buses enabled in the config file
    // should be disabled for flight?

    // assume all are enabled for right now
    //busPwr.sendPacket(thisFrame, MySerial);
    //busBME280.sendPacket(thisFrame, MySerial);
    busLSM9DS1.sendPacket(thisFrame, MySerial);
    //busADXL375.sendPacket(thisFrame, MySerial);
}

void setup() {
    MySerial.begin(1000000);
    //Wire2.begin(PB11, PB10); // I2C2

    //pinMode(CS_AG, OUTPUT);
    //pinMode(CS_MAG, OUTPUT);

    //digitalWrite(CS_AG, HIGH);
    //digitalWrite(CS_MAG, HIGH);

    //SPI.begin();
    
    // Simple check
    //uint8_t ag_id = LSM9DS1_ReadAG(0x0F);   // WHO_AM_I AG
    //uint8_t mag_id = LSM9DS1_ReadMAG(0x0F); // WHO_AM_I MAG

    //MySerial.print("AG WHO_AM_I: 0x"); MySerial.println(ag_id, HEX);
    //MySerial.print("MAG WHO_AM_I: 0x"); MySerial.println(mag_id, HEX);

    //if(ag_id != 0x68){
    //    Serial.println("AG sensor not detected!");
    //    while(1);
    //}

    // Start sensors
    //if(bme.begin(0x77, &Wire2)){
    //    bitSet(thisFrame.sensorsBIT, 0);
    //}

    beginLSM9DS1_AG();
    

    //if(lsm.begin()) {
    //    bitSet(thisFrame.sensorsBIT, 1);
    //}

    //if(adx.begin(0x53)) {
    //    bitSet(thisFrame.sensorsBIT, 2);
    //}   
}

void loop() {
    thisFrame.currentMillis = millis();
    if (thisFrame.currentMillis - lastReadLSM >= 1000 / busLSM9DS1.frequency) {
        lastReadLSM = thisFrame.currentMillis;

        readLSM9DS1_AG();
    }

    if((thisFrame.currentMillis - busLSM9DS1.lastSendTime) >= 1000 / busLSM9DS1.frequency){
        sendSerialBuses();
    }
}